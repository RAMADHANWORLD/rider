<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noman Restaurant - Live Rider Tracking Panel</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #d32f2f 0%, #ff5722 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .panel-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        .header {
            background: linear-gradient(135deg, #d32f2f 0%, #ff5722 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .panel-info {
            font-size: 1rem;
            opacity: 0.9;
        }


        .dashboard-container {
            padding: 1rem;
            display: none;
        }

        .dashboard-container.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #d32f2f;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #d32f2f;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .map-header {
            background: linear-gradient(135deg, #d32f2f 0%, #ff5722 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        #tracking-map {
            width: 100%;
            height: 500px;
            border: none;
        }

        .riders-list {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .riders-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .riders-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .rider-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rider-item:last-child {
            border-bottom: none;
        }

        .rider-info {
            flex: 1;
        }

        .rider-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.3rem;
        }

        .rider-details {
            font-size: 0.8rem;
            color: #666;
        }

        .rider-status {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .status-busy {
            background: #fff3cd;
            color: #856404;
        }


        .refresh-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 1rem;
        }

        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #d32f2f;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            color: #28a745;
            margin-left: 0.5rem;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .last-update {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .no-riders {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .rider-coordinates {
            font-family: monospace;
            font-size: 0.8rem;
            color: #888;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .map-control-btn {
            background: white;
            border: 2px solid #d32f2f;
            color: #d32f2f;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .map-control-btn:hover {
            background: #d32f2f;
            color: white;
        }

        @media (max-width: 768px) {
            .panel-container {
                max-width: 100%;
                border-radius: 0;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            #tracking-map {
                height: 300px;
            }
            
            .riders-content {
                max-height: 300px;
            }
            
        }
    </style>
</head>
<body>
    <div class="panel-container">
        <!-- Dashboard Screen -->
        <div id="dashboard-screen">
            <div class="header">
                <div class="logo">üçΩÔ∏è Noman Restaurant</div>
                <div class="panel-info">
                    Live Rider Tracking Panel
                    <span class="live-indicator">
                        <span class="live-dot"></span>
                        LIVE
                    </span>
                </div>
            </div>

            <div class="dashboard-container active">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-riders">0</div>
                        <div class="stat-label">Total Riders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="online-riders">0</div>
                        <div class="stat-label">Online Riders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="active-orders">0</div>
                        <div class="stat-label">Active Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-response">--</div>
                        <div class="stat-label">Avg Response Time</div>
                    </div>
                </div>

                <!-- Live Map -->
                <div class="map-container">
                    <div class="map-header">
                        üó∫Ô∏è Live Rider Locations
                        <button class="refresh-btn" onclick="refreshMap()">üîÑ Refresh</button>
                    </div>
                    <div style="position: relative;">
                        <div id="tracking-map"></div>
                        <div class="map-controls">
                            <button class="map-control-btn" onclick="centerMapOnRiders()">üìç Center All</button>
                            <button class="map-control-btn" onclick="toggleMapView()">üîÑ Toggle View</button>
                        </div>
                    </div>
                    <div class="last-update" id="map-last-update">
                        Last updated: --
                    </div>
                </div>

                <!-- Riders List -->
                <div class="riders-list">
                    <div class="riders-header">
                        üë• Active Riders
                        <button class="refresh-btn" onclick="loadRiders()">üîÑ Refresh</button>
                    </div>
                    <div class="riders-content" id="riders-content">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading riders...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - IMPORTANT: Replace with your actual Supabase credentials
        const SUPABASE_URL = 'https://your-project-ref.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let map = null;
        let ridersMarkers = [];
        let isMapInitialized = false;
        let refreshInterval = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Live Tracking Panel initialized');
            
            // Auto-start dashboard
            showDashboard();
        });


        function showDashboard() {
            // Initialize dashboard
            initializeMap();
            loadRiders();
            startRealtimeUpdates();
        }


        function initializeMap() {
            if (isMapInitialized || !document.getElementById('tracking-map')) return;
            
            try {
                // Initialize map centered on a default location (you can change this)
                map = L.map('tracking-map').setView([24.827383, 67.112053], 13); // Noman Restaurant Karachi coordinates
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                isMapInitialized = true;
                console.log('Map initialized successfully');
                
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }

        async function loadRiders() {
            try {
                console.log('Loading riders...');
                
                // Fetch all riders from database
                const { data: riders, error } = await supabase
                    .from('riders')
                    .select('*')
                    .order('name');

                if (error) {
                    console.error('Error loading riders:', error);
                    return;
                }

                console.log('Loaded riders:', riders);
                
                updateRidersStats(riders);
                updateRidersList(riders);
                updateRidersOnMap(riders);
                
                document.getElementById('map-last-update').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
                    
            } catch (error) {
                console.error('Error in loadRiders:', error);
            }
        }

        function updateRidersStats(riders) {
            const totalRiders = riders.length;
            const onlineRiders = riders.filter(r => r.is_online).length;
            
            document.getElementById('total-riders').textContent = totalRiders;
            document.getElementById('online-riders').textContent = onlineRiders;
            
            // You can add more stats here like active orders
            // For now, showing placeholder values
            document.getElementById('active-orders').textContent = Math.floor(onlineRiders * 0.7);
            document.getElementById('avg-response').textContent = '8 min';
        }

        function updateRidersList(riders) {
            const ridersContent = document.getElementById('riders-content');
            
            if (riders.length === 0) {
                ridersContent.innerHTML = `
                    <div class="no-riders">
                        <h3>No riders found</h3>
                        <p>No riders are registered in the system.</p>
                    </div>
                `;
                return;
            }

            const ridersHTML = riders.map(rider => {
                const statusClass = rider.is_online ? 'status-online' : 'status-offline';
                const statusText = rider.is_online ? 'Online' : 'Offline';
                const lastUpdate = rider.updated_at ? 
                    new Date(rider.updated_at).toLocaleString() : 'Never';
                
                let locationText = 'No location data';
                if (rider.latitude && rider.longitude) {
                    locationText = `${rider.latitude.toFixed(4)}, ${rider.longitude.toFixed(4)}`;
                }

                return `
                    <div class="rider-item">
                        <div class="rider-info">
                            <div class="rider-name">${rider.name}</div>
                            <div class="rider-details">
                                Username: ${rider.username}<br>
                                Phone: ${rider.phone || 'Not provided'}<br>
                                Location: <span class="rider-coordinates">${locationText}</span><br>
                                Last Update: ${lastUpdate}
                            </div>
                        </div>
                        <div class="rider-status ${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');

            ridersContent.innerHTML = ridersHTML;
        }

        function updateRidersOnMap(riders) {
            if (!map || !isMapInitialized) return;

            // Clear existing markers
            ridersMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            ridersMarkers = [];

            // Add markers for riders with location data
            const ridersWithLocation = riders.filter(rider => 
                rider.latitude && rider.longitude
            );

            ridersWithLocation.forEach(rider => {
                const isOnline = rider.is_online;
                const markerColor = isOnline ? '#28a745' : '#dc3545';
                const statusText = isOnline ? 'Online' : 'Offline';

                const riderIcon = L.divIcon({
                    html: `<div style="
                        background: ${markerColor};
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 0 10px rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        color: white;
                        font-weight: bold;
                    ">üõµ</div>`,
                    iconSize: [24, 24],
                    className: 'rider-marker'
                });

                const marker = L.marker([rider.latitude, rider.longitude], { icon: riderIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="text-align: center; min-width: 200px;">
                            <strong>üõµ ${rider.name}</strong><br>
                            <span style="color: ${markerColor}; font-weight: bold;">${statusText}</span><br>
                            <small>Phone: ${rider.phone || 'Not provided'}</small><br>
                            <small>Lat: ${rider.latitude.toFixed(6)}</small><br>
                            <small>Lng: ${rider.longitude.toFixed(6)}</small><br>
                            <small>Updated: ${rider.updated_at ? 
                                new Date(rider.updated_at).toLocaleString() : 'Never'}</small>
                        </div>
                    `);

                ridersMarkers.push(marker);
            });

            console.log(`Added ${ridersMarkers.length} rider markers to map`);

            // Auto-fit map to show all riders if there are any
            if (ridersMarkers.length > 0) {
                const group = new L.featureGroup(ridersMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function centerMapOnRiders() {
            if (!map || ridersMarkers.length === 0) return;
            
            const group = new L.featureGroup(ridersMarkers);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        function toggleMapView() {
            if (!map) return;
            
            // Toggle between street and satellite view (if you have satellite tiles)
            // For now, just zoom to different levels
            const currentZoom = map.getZoom();
            const newZoom = currentZoom > 13 ? 11 : 15;
            map.setZoom(newZoom);
        }

        function refreshMap() {
            loadRiders();
        }

        function startRealtimeUpdates() {
            // Refresh data every 30 seconds
            refreshInterval = setInterval(() => {
                loadRiders();
            }, 30000);

            // Setup real-time subscription to riders table changes
            const subscription = supabase
                .channel('riders-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'riders'
                    },
                    (payload) => {
                        console.log('Real-time update received:', payload);
                        loadRiders(); // Refresh the display
                    }
                )
                .subscribe();

            console.log('Real-time updates started');
        }

        // Utility function to show toast notifications (optional)
        function showToast(message, type = 'info') {
            console.log(`Toast (${type}): ${message}`);
            // You can implement actual toast notifications here if needed
        }

        // Handle window resize for responsive map
        window.addEventListener('resize', function() {
            if (map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        });
    </script>
</body>
</html>