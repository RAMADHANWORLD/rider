<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noman Restaurant - Rider App</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #d32f2f 0%, #ff5722 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #d32f2f 0%, #ff5722 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .rider-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .login-container {
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: calc(100vh - 100px);
        }

        .login-form {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .welcome-text {
            text-align: center;
            margin-bottom: 2rem;
        }

        .welcome-text h2 {
            color: #d32f2f;
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
        }

        .welcome-text p {
            color: #666;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-input:focus {
            outline: none;
            border-color: #d32f2f;
            background: white;
            box-shadow: 0 0 10px rgba(211, 47, 47, 0.1);
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d32f2f 0%, #ff5722 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .dashboard-container {
            padding: 1rem;
            display: none;
        }

        .dashboard-container.active {
            display: block;
        }

        .status-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #d32f2f;
        }

        .status-online {
            border-left-color: #28a745;
        }

        .status-busy {
            border-left-color: #ffc107;
        }

        .status-offline {
            border-left-color: #dc3545;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.online {
            background: #28a745;
        }

        .status-dot.busy {
            background: #ffc107;
        }

        .location-card {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .location-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .location-accuracy {
            font-size: 0.8rem;
            color: #666;
        }

        .coordinates {
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 5px;
            margin-top: 0.5rem;
        }

        .order-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #ff5722;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .order-number {
            font-weight: bold;
            color: #d32f2f;
            font-size: 1.1rem;
        }

        .order-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            background: #fff3cd;
            color: #856404;
        }

        .customer-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .customer-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .customer-details {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .order-items {
            margin: 1rem 0;
        }

        .item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .item:last-child {
            border-bottom: none;
        }

        .total-amount {
            background: #d32f2f;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin: 1rem 0;
        }

        .action-buttons {
            display: grid;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            text-align: center;
            padding: 3rem 1rem;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #d32f2f;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .logout-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-btn:hover {
            background: white;
            color: #d32f2f;
        }

        .no-orders {
            text-align: center;
            padding: 3rem 1rem;
            color: #666;
        }

        .no-orders h3 {
            color: #d32f2f;
            margin-bottom: 1rem;
        }

        .location-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .location-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);
        }

        .phone-link {
            color: #d32f2f;
            text-decoration: none;
            font-weight: 600;
        }

        .phone-link:hover {
            text-decoration: underline;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .app-container {
                max-width: 100%;
                border-radius: 0;
            }
            
            .login-container {
                padding: 1rem;
            }
            
            .login-form {
                padding: 1.5rem;
            }
        }

        /* Floating action style for delivered button */
        .floating-action {
            position: fixed;
            bottom: 2rem;
            right: 1rem;
            left: 1rem;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .floating-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(40, 167, 69, 0.4);
        }

        .floating-action:disabled {
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }

        /* ENHANCED LIVE LOCATION STYLES - NEW FEATURES ADDED */
        .live-location-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            color: #28a745;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .location-timestamp {
            font-size: 0.7rem;
            color: #888;
            margin-top: 0.3rem;
        }

        .location-quality {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .quality-high {
            background: #d4edda;
            color: #155724;
        }

        .quality-medium {
            background: #fff3cd;
            color: #856404;
        }

        .quality-low {
            background: #f8d7da;
            color: #721c24;
        }

        .location-details {
            background: #e8f5e8;
            padding: 0.8rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            border-left: 3px solid #28a745;
        }

        .location-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.3rem;
            background: rgba(255,255,255,0.7);
            border-radius: 5px;
        }

        .stat-value {
            font-weight: bold;
            color: #d32f2f;
        }

        .location-error {
            background: #f8d7da;
            color: #721c24;
            padding: 0.8rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            border-left: 3px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="login-screen">
            <div class="header">
                <div class="logo">🍽️ Noman Restaurant</div>
                <div class="rider-info">Rider App</div>
            </div>
            
            <div class="login-container">
                <div class="login-form">
                    <div class="welcome-text">
                        <h2>Welcome Back!</h2>
                        <p>Sign in to start delivering delicious food</p>
                    </div>
                    
                    <form id="login-form">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" id="username" class="form-input" required placeholder="Enter your username">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="password" class="form-input" required placeholder="Enter your password">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Sign In</button>
                    </form>
                    
                    <div id="login-error" class="alert alert-error" style="display: none;">
                        Invalid username or password
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" style="display: none;">
            <div class="header">
                <div class="logo">🍽️ Noman Restaurant</div>
                <div class="rider-info" id="rider-name">Rider Dashboard</div>
                <button class="logout-btn" onclick="logout()" title="Logout">⟲</button>
            </div>

            <div class="dashboard-container active">
                <!-- Rider Status Card -->
                <div class="status-card" id="status-card">
                    <div class="status-indicator">
                        <div class="status-dot" id="status-dot"></div>
                        <strong id="status-text">Offline</strong>
                    </div>
                    <button class="btn btn-primary" id="toggle-status" onclick="toggleOnlineStatus()">Go Online</button>
                </div>

                <!-- Enhanced Live Location Card -->
                <div class="location-card">
                    <div class="location-status">
                        <strong>📍 Live Location</strong>
                        <span class="location-accuracy" id="location-accuracy">Getting location...</span>
                    </div>
                    <div class="coordinates" id="coordinates">Location not available</div>
                    
                    <!-- Live tracking indicator -->
                    <div class="live-location-indicator" id="live-indicator" style="display: none;">
                        <div class="live-dot"></div>
                        <span>Live tracking active</span>
                    </div>
                    
                    <!-- Location quality indicator -->
                    <div class="location-quality" id="location-quality" style="display: none;"></div>
                    
                    <!-- Location details -->
                    <div class="location-details" id="location-details" style="display: none;">
                        <div class="location-timestamp" id="location-timestamp">Last updated: Never</div>
                        <div class="location-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="speed">--</div>
                                <div>Speed (km/h)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="altitude">--</div>
                                <div>Altitude (m)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location error display -->
                    <div class="location-error" id="location-error" style="display: none;"></div>
                    
                    <button class="location-btn" onclick="updateLocation()">Update Location</button>
                </div>

                <!-- Orders Container -->
                <div id="orders-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading your orders...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://ifdshbxoaziywoytxbdi.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlmZHNoYnhvYXppeXdveXR4YmRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTE5NTEsImV4cCI6MjA3MjM4Nzk1MX0.2umKS_lgtQ6bVP0iDN0Ifs16nWCgxs4SOarcIOpyv8c';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables
        let currentRider = null;
        let isOnline = false;
        let watchId = null;
        let currentOrders = [];
        let lastLocationUpdate = null;
        let locationUpdateInterval = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkLoginStatus();
        });

        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Check for stored login
            const storedRider = localStorage.getItem('currentRider');
            if (storedRider) {
                currentRider = JSON.parse(storedRider);
                showDashboard();
            }
        }

        function checkLoginStatus() {
            const storedRider = localStorage.getItem('currentRider');
            if (storedRider) {
                currentRider = JSON.parse(storedRider);
                showDashboard();
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                // Query riders table for authentication
                const { data, error } = await supabase
                    .from('riders')
                    .select('*')
                    .eq('username', username)
                    .single();

                if (error || !data) {
                    showLoginError();
                    return;
                }

                // In a real app, you'd hash and compare passwords
                // For this demo, we'll do simple comparison
                if (data.password !== password) {
                    showLoginError();
                    return;
                }

                currentRider = data;
                localStorage.setItem('currentRider', JSON.stringify(currentRider));
                showDashboard();
                
            } catch (error) {
                console.error('Login error:', error);
                showLoginError();
            }
        }

        function showLoginError() {
            document.getElementById('login-error').style.display = 'block';
            setTimeout(() => {
                document.getElementById('login-error').style.display = 'none';
            }, 3000);
        }

        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-screen').style.display = 'block';
            
            document.getElementById('rider-name').textContent = `Welcome, ${currentRider.name}`;
            
            updateRiderStatus();
            startEnhancedLocationTracking(); // Enhanced location tracking
            loadRiderOrders();
            setupRealtimeSubscription();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                stopLocationTracking();
                localStorage.removeItem('currentRider');
                currentRider = null;
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('dashboard-screen').style.display = 'none';
                document.getElementById('login-form').reset();
            }
        }

        async function toggleOnlineStatus() {
            try {
                const newStatus = !isOnline;
                
                const { error } = await supabase
                    .from('riders')
                    .update({ is_online: newStatus })
                    .eq('id', currentRider.id);

                if (error) {
                    console.error('Error updating status:', error);
                    showToast('Failed to update status', 'error');
                    return;
                }

                isOnline = newStatus;
                currentRider.is_online = newStatus;
                localStorage.setItem('currentRider', JSON.stringify(currentRider));
                
                updateRiderStatus();
                showToast(`You are now ${newStatus ? 'online' : 'offline'}!`, 'success');
                
                if (newStatus) {
                    updateLocation();
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Failed to update status', 'error');
            }
        }

        function updateRiderStatus() {
            isOnline = currentRider.is_online;
            const statusCard = document.getElementById('status-card');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const toggleBtn = document.getElementById('toggle-status');

            if (isOnline) {
                statusCard.className = 'status-card status-online';
                statusDot.className = 'status-dot online';
                statusText.textContent = 'Online - Ready for deliveries';
                toggleBtn.textContent = 'Go Offline';
                toggleBtn.className = 'btn btn-danger';
            } else {
                statusCard.className = 'status-card status-offline';
                statusDot.className = 'status-dot';
                statusText.textContent = 'Offline';
                toggleBtn.textContent = 'Go Online';
                toggleBtn.className = 'btn btn-primary';
            }
        }

        // ENHANCED LIVE LOCATION TRACKING FUNCTIONALITY
        function startEnhancedLocationTracking() {
            if (navigator.geolocation) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 10000
                };

                // Start watching position
                watchId = navigator.geolocation.watchPosition(
                    handleLocationSuccess,
                    handleLocationError,
                    options
                );

                // Set up periodic location updates every 30 seconds
                locationUpdateInterval = setInterval(() => {
                    if (navigator.geolocation && isOnline) {
                        navigator.geolocation.getCurrentPosition(
                            handleLocationSuccess,
                            handleLocationError,
                            options
                        );
                    }
                }, 30000);

                // Show live tracking indicator
                document.getElementById('live-indicator').style.display = 'flex';
                
            } else {
                showLocationError('Geolocation is not supported by this browser');
            }
        }

        function handleLocationSuccess(position) {
            const { coords } = position;
            const { latitude, longitude, accuracy, speed, altitude, heading } = coords;
            
            lastLocationUpdate = new Date();
            
            // Hide error display
            document.getElementById('location-error').style.display = 'none';
            
            // Show location details
            document.getElementById('location-details').style.display = 'block';
            
            // Update coordinates display
            document.getElementById('coordinates').innerHTML = 
                `Lat: ${latitude.toFixed(6)}<br>Lng: ${longitude.toFixed(6)}`;
            
            // Update accuracy with quality indicator
            updateLocationAccuracy(accuracy);
            
            // Update timestamp
            document.getElementById('location-timestamp').textContent = 
                `Last updated: ${lastLocationUpdate.toLocaleTimeString()}`;
            
            // Update additional stats
            document.getElementById('speed').textContent = 
                speed ? Math.round(speed * 3.6) : '--'; // Convert m/s to km/h
            document.getElementById('altitude').textContent = 
                altitude ? Math.round(altitude) : '--';
            
            // Send location to server
            sendLocationToServer({
                latitude,
                longitude,
                accuracy,
                speed,
                altitude,
                heading,
                timestamp: lastLocationUpdate.toISOString()
            });
            
            console.log('Location updated:', { latitude, longitude, accuracy });
        }

        function handleLocationError(error) {
            let errorMessage = 'Location unavailable';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Location access denied. Please enable location permissions for this app.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Location information is unavailable. Check your GPS settings.';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'Location request timed out. Trying again...';
                    setTimeout(() => updateLocation(), 5000);
                    break;
                default:
                    errorMessage = 'An unknown error occurred while retrieving location.';
            }
            
            showLocationError(errorMessage);
        }

        function showLocationError(message) {
            document.getElementById('location-error').style.display = 'block';
            document.getElementById('location-error').textContent = message;
            document.getElementById('location-details').style.display = 'none';
            document.getElementById('coordinates').innerHTML = 
                '<span style="color: #dc3545;">Location Error</span>';
            document.getElementById('location-accuracy').textContent = 'Error';
        }

        function updateLocationAccuracy(accuracy) {
            const accuracyElement = document.getElementById('location-accuracy');
            const qualityElement = document.getElementById('location-quality');
            
            accuracyElement.textContent = `±${Math.round(accuracy)}m`;
            qualityElement.style.display = 'inline-block';
            
            // Determine quality based on accuracy
            if (accuracy <= 10) {
                qualityElement.textContent = 'High Precision';
                qualityElement.className = 'location-quality quality-high';
            } else if (accuracy <= 50) {
                qualityElement.textContent = 'Good Precision';
                qualityElement.className = 'location-quality quality-medium';
            } else {
                qualityElement.textContent = 'Low Precision';
                qualityElement.className = 'location-quality quality-low';
            }
        }

        function updateLocation() {
            if (!navigator.geolocation) {
                showLocationError('Geolocation is not supported by this browser');
                return;
            }

            document.getElementById('coordinates').innerHTML = 'Updating location...';
            document.getElementById('location-accuracy').textContent = 'Searching...';
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0 // Force fresh location
            };

            navigator.geolocation.getCurrentPosition(
                handleLocationSuccess,
                handleLocationError,
                options
            );
        }

        async function sendLocationToServer(locationData) {
            if (!currentRider) return;
            
            try {
                const payload = {
                    rider_id: currentRider.id,
                    ...locationData
                };
                
                // Send to Supabase (uncomment when table is ready)
                /*
                const { error } = await supabase
                    .from('rider_locations')
                    .insert([payload]);
                
                if (error) {
                    console.error('Error sending location:', error);
                } else {
                    console.log('Location sent successfully');
                }
                */
                
                // For now, just log the data
                console.log('Location data ready to send:', payload);
                
            } catch (error) {
                console.error('Error preparing location data:', error);
            }
        }

        function stopLocationTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            if (locationUpdateInterval) {
                clearInterval(locationUpdateInterval);
                locationUpdateInterval = null;
            }
            
            // Hide live indicator
            document.getElementById('live-indicator').style.display = 'none';
        }

        // EXISTING FUNCTIONALITY - UNCHANGED
        async function loadRiderOrders() {
            if (!currentRider) return;

            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        customers (
                            name,
                            phone,
                            address
                        ),
                        order_items (
                            quantity,
                            menu_items (
                                name,
                                price
                            )
                        )
                    `)
                    .eq('rider_id', currentRider.id)
                    .in('status', ['assigned', 'picked_up', 'out_for_delivery']);

                if (error) {
                    console.error('Error loading orders:', error);
                    return;
                }

                currentOrders = orders || [];
                displayOrders();
                
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function displayOrders() {
            const container = document.getElementById('orders-container');
            
            if (currentOrders.length === 0) {
                container.innerHTML = `
                    <div class="no-orders">
                        <h3>No Active Orders</h3>
                        <p>${isOnline ? 'Waiting for new orders...' : 'Go online to receive orders'}</p>
                    </div>
                `;
                return;
            }

            let ordersHTML = '';
            currentOrders.forEach(order => {
                const customer = order.customers;
                const items = order.order_items || [];
                
                let total = 0;
                const itemsHTML = items.map(item => {
                    const itemTotal = item.quantity * item.menu_items.price;
                    total += itemTotal;
                    return `
                        <div class="item">
                            <span>${item.quantity}x ${item.menu_items.name}</span>
                            <span>$${itemTotal.toFixed(2)}</span>
                        </div>
                    `;
                }).join('');

                ordersHTML += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-number">#${order.order_number}</div>
                            <div class="order-status">${getStatusText(order.status)}</div>
                        </div>
                        
                        <div class="customer-info">
                            <div class="customer-name">👤 ${customer?.name || 'N/A'}</div>
                            <div class="customer-details">
                                📞 <a href="tel:${customer?.phone || ''}" class="phone-link">${customer?.phone || 'N/A'}</a><br>
                                📍 ${customer?.address || 'N/A'}<br>
                                🕒 ${formatDate(order.created_at)}
                            </div>
                        </div>
                        
                        <div class="order-items">
                            <strong>Order Items:</strong>
                            ${itemsHTML}
                        </div>
                        
                        <div class="total-amount">
                            Total: $${total.toFixed(2)}
                        </div>
                        
                        <div class="action-buttons">
                            ${getOrderButtons(order)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = ordersHTML;
        }

        function getStatusText(status) {
            const statusMap = {
                'assigned': 'Ready for Pickup',
                'picked_up': 'Picked Up',
                'out_for_delivery': 'Out for Delivery',
                'delivered': 'Delivered'
            };
            return statusMap[status] || status;
        }

        function getOrderButtons(order) {
            switch(order.status) {
                case 'assigned':
                    return `<button class="btn btn-success" onclick="pickupOrder('${order.id}')">Mark as Picked Up</button>`;
                case 'picked_up':
                    return `<button class="btn btn-primary" onclick="startDelivery('${order.id}')">Start Delivery</button>`;
                case 'out_for_delivery':
                    return `<button class="floating-action" onclick="completeDelivery('${order.id}')">Mark as Delivered</button>`;
                default:
                    return '';
            }
        }

        async function pickupOrder(orderId) {
            await updateOrderStatus(orderId, 'picked_up');
        }

        async function startDelivery(orderId) {
            await updateOrderStatus(orderId, 'out_for_delivery');
        }

        async function completeDelivery(orderId) {
            if (confirm('Confirm delivery completion?')) {
                await updateOrderStatus(orderId, 'delivered');
            }
        }

        async function updateOrderStatus(orderId, status) {
            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ status })
                    .eq('id', orderId);

                if (error) {
                    showToast('Failed to update order status', 'error');
                    return;
                }

                showToast('Order status updated successfully!', 'success');
                loadRiderOrders();
                
            } catch (error) {
                console.error('Error updating order:', error);
                showToast('Failed to update order status', 'error');
            }
        }

        function setupRealtimeSubscription() {
            // Subscribe to new orders for this rider
            supabase
                .channel('rider-orders')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'orders',
                    filter: `rider_id=eq.${currentRider.id}`
                }, (payload) => {
                    console.log('Order update received:', payload);
                    loadRiderOrders();
                    
                    if (payload.eventType === 'INSERT') {
                        showToast('New order assigned!', 'info');
                        // Could add notification sound here
                    }
                })
                .subscribe();
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type}`;
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.zIndex = '1000';
            toast.style.minWidth = '300px';
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Handle double-tap zoom disable on mobile
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Handle app visibility changes for enhanced location tracking
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // App hidden - reduce location frequency but keep tracking
                console.log('App hidden - maintaining background location tracking');
            } else {
                // App visible - ensure full tracking is active
                if (currentRider && isOnline && !watchId) {
                    console.log('App visible - resuming location tracking');
                    startEnhancedLocationTracking();
                }
                if (currentRider) {
                    loadRiderOrders();
                }
            }
        });

        // Enhanced error handling for network issues
        window.addEventListener('online', function() {
            console.log('Network connection restored');
            if (currentRider) {
                loadRiderOrders();
                updateLocation(); // Refresh location when back online
            }
        });

        window.addEventListener('offline', function() {
            console.log('Network connection lost');
            showToast('Network connection lost. App will sync when reconnected.', 'error');
        });
    </script>
</body>
</html>